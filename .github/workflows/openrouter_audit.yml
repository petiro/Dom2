name: OpenRouter AI Auditor

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'SHA del vecchio commit da controllare'
        required: true

permissions:
  contents: write
  actions: read

jobs:
  ai_review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Requests
        run: pip install requests

      - name: Extract Diff
        id: extract
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TARGET_SHA="${{ inputs.commit_sha }}"
            echo "üîß Manual Mode: $TARGET_SHA"
            git diff $TARGET_SHA^ $TARGET_SHA > commit_diff.txt
            echo "REVIEW_SHA=$TARGET_SHA" >> $GITHUB_ENV
          else
            echo "üöÄ Push Mode"
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.event.after }}"
            if [ -z "$BEFORE" ] || [ "$BEFORE" == "0000000000000000000000000000000000000000" ]; then
               git diff 4b825dc642cb6eb9a060e54bf8d69288fbee4904 $AFTER > commit_diff.txt
            else
               git diff $BEFORE $AFTER > commit_diff.txt
            fi
            echo "REVIEW_SHA=$AFTER" >> $GITHUB_ENV
          fi

      - name: AI Analysis (2026 Free Models)
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          python -c '
          import os
          import requests
          import json
          import time

          # LISTA MODELLI AGGIORNATA (Febbraio 2026 - Basata sul tuo dump)
          # Ho scelto quelli specifici per Coding e Reasoning
          MODELS = [
              "openai/gpt-oss-120b:free",                 # NUOVO! Ottimo per reasoning e production
              "qwen/qwen-3-coder-480b-a35b-instruct:free", # BEST IN CLASS per il codice (480B MoE)
              "arcee-ai/trinity-large-preview:free",       # Il pi√π usato al momento (400B MoE)
              "meta-llama/llama-3.3-70b-instruct:free",    # Classico fallback (spesso 429)
              "stepfun/step-3.5-flash:free"                # Velocissimo se gli altri falliscono
          ]
          
          api_key = os.environ.get("OPENROUTER_API_KEY")

          try:
              with open("commit_diff.txt", "r", encoding="utf-8", errors="replace") as f:
                  diff_content = f.read()
          except:
              diff_content = ""

          if len(diff_content.strip()) < 5:
              print("Diff vuoto.")
              with open("ai_report.md", "w") as f: f.write("Nessuna modifica rilevante.")
              exit(0)

          # Tronca a 30k caratteri (Questi modelli gestiscono contesti ampi, ma stiamo sicuri)
          diff_content = diff_content[:30000]

          prompt = f"""
          Sei un Senior Code Reviewer.
          Analizza il seguente git diff.
          
          DIFF:
          {diff_content}
          
          OUTPUT: Markdown.
          Usa üö® per errori critici (password, bug logici).
          Usa ‚úÖ per codice pulito.
          Sii BREVE e professionale.
          """

          success = False
          
          for model in MODELS:
              print(f"üîÑ Tentativo con modello: {model}...")
              
              # Tenta fino a 2 volte per lo stesso modello se c √® errore 429
              for attempt in range(2):
                  try:
                      response = requests.post(
                          url="https://openrouter.ai/api/v1/chat/completions",
                          headers={
                              "Authorization": f"Bearer {api_key}",
                              "HTTP-Referer": "https://github.com/v4-agent",
                              "Content-Type": "application/json"
                          },
                          json={
                              "model": model,
                              "messages": [{"role": "user", "content": prompt}],
                              "temperature": 0.2
                          },
                          timeout=50
                      )
                      
                      if response.status_code == 200:
                          data = response.json()
                          if "choices" in data and len(data["choices"]) > 0:
                              report = data["choices"][0]["message"]["content"]
                              
                              header = f"### ü§ñ AI Review ({model})\n\n"
                              with open("ai_report.md", "w", encoding="utf-8") as f:
                                  f.write(header + report)
                              with open(os.environ["GITHUB_STEP_SUMMARY"], "a") as f:
                                  f.write(header + report)
                              
                              print("‚úÖ Successo!")
                              success = True
                              break # Esce dal loop tentativi
                          else:
                              print(f"‚ö†Ô∏è Risposta vuota da {model}")
                              break
                      
                      elif response.status_code == 429:
                          print(f"‚è≥ Rate Limit (429) con {model}. Attendo 5s...")
                          time.sleep(5)
                          continue # Riprova lo stesso modello
                          
                      elif response.status_code == 404:
                          print(f"‚ùå Modello non trovato (404): {model}. Passo al prossimo.")
                          break # Cambia modello subito
                          
                      else:
                          print(f"‚ö†Ô∏è Errore {response.status_code} con {model}: {response.text}")
                          break # Cambia modello
                          
                  except Exception as e:
                      print(f"‚ö†Ô∏è Eccezione con {model}: {e}")
                      break

              if success:
                  break # Esce dal loop modelli (abbiamo finito)

          if not success:
              err_msg = "‚ùå Tutti i modelli AI sono falliti. Verifica i log per dettagli."
              print(err_msg)
              with open("ai_report.md", "w", encoding="utf-8") as f: f.write(err_msg)
          '

      - name: Post Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f ai_report.md ]; then
            SHA="${{ env.REVIEW_SHA }}"
            gh api --method POST \
              -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/commits/$SHA/comments \
              -F body=@ai_report.md || echo "Impossibile commentare (SHA non valido?)"
          fi
