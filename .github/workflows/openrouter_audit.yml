name: OpenRouter AI Auditor

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ai_review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Requests
        run: pip install requests

      - name: Extract Diff
        run: |
          BEFORE_SHA="${{ github.event.before }}"
          AFTER_SHA="${{ github.event.after }}"
          
          # Gestione primo commit
          if [ -z "$BEFORE_SHA" ] || [ "$BEFORE_SHA" == "0000000000000000000000000000000000000000" ]; then
             git diff 4b825dc642cb6eb9a060e54bf8d69288fbee4904 $AFTER_SHA > commit_diff.txt
          else
             git diff $BEFORE_SHA $AFTER_SHA > commit_diff.txt
          fi

      - name: AI Analysis & Summary
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          python -c '
          import os
          import requests
          import json

          MODEL = "google/gemini-2.0-flash-exp:free"
          api_key = os.environ.get("OPENROUTER_API_KEY")

          # 1. Leggi Diff
          try:
              with open("commit_diff.txt", "r", encoding="utf-8", errors="replace") as f:
                  diff_content = f.read()
          except:
              diff_content = ""

          if len(diff_content.strip()) < 5:
              print("Diff vuoto o inesistente.")
              with open(os.environ["GITHUB_STEP_SUMMARY"], "a") as f:
                  f.write("### â„¹ï¸ Nessuna modifica al codice rilevata.")
              exit(0)

          # 2. Tronca (max 15k char per sicurezza)
          diff_content = diff_content[:15000]

          # 3. Chiamata AI
          prompt = f"""
          Sei un Senior Code Reviewer. Analizza questo commit diff.
          Rispondi in Markdown.
          
          Struttura la risposta cosÃ¬:
          ### ðŸ“Š Analisi Commit
          * **Stato:** [APPROVATO / ATTENZIONE / PERICOLO]
          * **Sintesi:** (Cosa Ã¨ cambiato in 1 frase)
          
          ### ðŸ” Dettagli
          (Elenca bug, chiavi esposte o miglioramenti)

          DIFF:
          {diff_content}
          """

          try:
              print("Invio richiesta a OpenRouter...")
              response = requests.post(
                  url="https://openrouter.ai/api/v1/chat/completions",
                  headers={
                      "Authorization": f"Bearer {api_key}",
                      "HTTP-Referer": "https://github.com/v4-agent",
                      "Content-Type": "application/json"
                  },
                  json={
                      "model": MODEL,
                      "messages": [{"role": "user", "content": prompt}]
                  },
                  timeout=60
              )
              
              if response.status_code == 200:
                  report = response.json()["choices"][0]["message"]["content"]
                  
                  # 4. SCRITTURA NEL RIEPILOGO (GARANTITO VISIBILE)
                  with open(os.environ["GITHUB_STEP_SUMMARY"], "a") as f:
                      f.write(f"# ðŸ¤– Report AI ({MODEL})\n\n")
                      f.write(report)
                  
                  # Stampa anche nei log per debug
                  print("-" * 20)
                  print(report)
                  print("-" * 20)
              else:
                  error_msg = f"âŒ Errore API OpenRouter: {response.status_code} - {response.text}"
                  print(error_msg)
                  with open(os.environ["GITHUB_STEP_SUMMARY"], "a") as f:
                      f.write(error_msg)

          except Exception as e:
              print(f"Errore critico: {e}")
              with open(os.environ["GITHUB_STEP_SUMMARY"], "a") as f:
                  f.write(f"### âŒ Errore Script: {e}")
          '
