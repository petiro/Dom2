name: OpenRouter AI Auditor

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'SHA del vecchio commit da controllare (es. a1b2c3d)'
        required: true

permissions:
  contents: write
  actions: read

jobs:
  ai_review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Requests
        run: pip install requests

      - name: Extract Diff (Auto & Manual)
        id: extract
        run: |
          # LOGICA DOPPIA: PUSH AUTOMATICO O MANUALE
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # --- MODALITA MANUALE ---
            TARGET_SHA="${{ inputs.commit_sha }}"
            echo "Manual Mode: Analisi commit $TARGET_SHA"
            
            # Calcola diff tra il commit scelto e il precedente
            git diff $TARGET_SHA^ $TARGET_SHA > commit_diff.txt
            
            # Salva lo SHA per commentare dopo
            echo "REVIEW_SHA=$TARGET_SHA" >> $GITHUB_ENV
            
          else
            # --- MODALITA PUSH AUTOMATICA ---
            echo "Push Mode: Analisi automatica"
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.event.after }}"
            
            if [ -z "$BEFORE" ] || [ "$BEFORE" == "0000000000000000000000000000000000000000" ]; then
               git diff 4b825dc642cb6eb9a060e54bf8d69288fbee4904 $AFTER > commit_diff.txt
            else
               git diff $BEFORE $AFTER > commit_diff.txt
            fi
            
            echo "REVIEW_SHA=$AFTER" >> $GITHUB_ENV
          fi

      - name: AI Analysis
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          python -c '
          import os
          import requests
          import json

          # MODELLO AGGIORNATO (Quello vecchio dava 404)
          MODEL = "google/gemini-2.0-pro-exp-02-05:free"
          
          api_key = os.environ.get("OPENROUTER_API_KEY")

          try:
              with open("commit_diff.txt", "r", encoding="utf-8", errors="replace") as f:
                  diff_content = f.read()
          except:
              diff_content = ""

          if len(diff_content.strip()) < 5:
              print("Diff vuoto.")
              with open("ai_report.md", "w") as f: f.write("Nessuna modifica rilevante.")
              exit(0)

          # Tronca a 30k caratteri
          diff_content = diff_content[:30000]

          prompt = f"""
          Sei un Senior Code Reviewer. Analizza questo codice.
          
          DIFF:
          {diff_content}
          
          Formatta la risposta in Markdown.
          Usa ðŸš¨ per errori gravi (chiavi API, crash).
          Usa âœ… se Ã¨ tutto ok.
          Sii conciso.
          """

          try:
              response = requests.post(
                  url="https://openrouter.ai/api/v1/chat/completions",
                  headers={
                      "Authorization": f"Bearer {api_key}",
                      "HTTP-Referer": "https://github.com/v4-agent",
                      "Content-Type": "application/json"
                  },
                  json={
                      "model": MODEL,
                      "messages": [{"role": "user", "content": prompt}]
                  },
                  timeout=60
              )
              
              if response.status_code == 200:
                  report = response.json()["choices"][0]["message"]["content"]
                  
                  # Salva per il commento
                  with open("ai_report.md", "w", encoding="utf-8") as f:
                      f.write(f"### ðŸ¤– AI Review ({MODEL})\n\n{report}")
                      
                  # Scrivi nel Summary di GitHub
                  with open(os.environ["GITHUB_STEP_SUMMARY"], "a") as f:
                      f.write(f"### ðŸ¤– AI Review ({MODEL})\n\n{report}")
                  
              else:
                  print(f"Errore API: {response.text}")
                  with open("ai_report.md", "w") as f: f.write(f"Errore API: {response.text}")

          except Exception as e:
              print(f"Errore Script: {e}")
          '

      - name: Post Comment on Commit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f ai_report.md ]; then
            SHA="${{ env.REVIEW_SHA }}"
            echo "Postando commento su commit: $SHA"
            
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/commits/$SHA/comments \
              -F body=@ai_report.md || echo "Impossibile postare commento (forse SHA inesistente?)"
          fi
