name: OpenRouter AI Auditor

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write  # Necessario per commentare sui commit
  pull-requests: write

jobs:
  ai_review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests

      - name: Extract Commit Diff
        run: |
          BEFORE_SHA="${{ github.event.before }}"
          AFTER_SHA="${{ github.event.after }}"
          
          # Gestione primo commit o force push
          if [ "$BEFORE_SHA" == "0000000000000000000000000000000000000000" ]; then
             git diff 4b825dc642cb6eb9a060e54bf8d69288fbee4904 $AFTER_SHA > commit_diff.txt
          else
             git diff $BEFORE_SHA $AFTER_SHA > commit_diff.txt
          fi

      - name: OpenRouter Analysis
        id: ai_analysis
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          python -c '
          import os
          import requests
          import json

          # Modello Free (cambia se vuoi Llama)
          MODEL = "google/gemini-2.0-flash-exp:free"
          
          api_key = os.environ.get("OPENROUTER_API_KEY")
          
          try:
              with open("commit_diff.txt", "r", encoding="utf-8", errors="replace") as f:
                  diff_content = f.read()
          except:
              diff_content = ""

          if len(diff_content.strip()) < 10:
              print("Diff vuoto")
              exit(0)

          # Tronca a 25k caratteri per sicurezza
          diff_content = diff_content[:25000]

          prompt = f"""
          Sei un Code Reviewer esperto. Analizza questo commit.
          Sii BREVE e DIRETTO. Usa elenchi puntati.
          
          Se trovi:
          1. Chiavi API in chiaro -> SCRIVILO SUBITO IN GRASSETTO CON EMOJI ðŸš¨.
          2. Bug logici evidenti -> Segnalali.
          3. Codice pulito -> Scrivi solo "âœ… Codice approvato."
          
          DIFF:
          {diff_content}
          """

          try:
              response = requests.post(
                  url="https://openrouter.ai/api/v1/chat/completions",
                  headers={
                      "Authorization": f"Bearer {api_key}",
                      "HTTP-Referer": "https://github.com/v4-agent", 
                      "Content-Type": "application/json"
                  },
                  data=json.dumps({
                      "model": MODEL,
                      "messages": [{"role": "user", "content": prompt}]
                  })
              )
              
              if response.status_code == 200:
                  content = response.json()["choices"][0]["message"]["content"]
                  
                  # Salva il report per il prossimo step
                  with open("ai_report.md", "w", encoding="utf-8") as f:
                      f.write(f"### ðŸ¤– AI Review ({MODEL})\n\n" + content)
                  
                  print("Report generato con successo.")
              else:
                  print(f"Errore API: {response.text}")
          except Exception as e:
              print(f"Errore Python: {e}")
          '

      - name: Post Comment on Commit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f ai_report.md ]; then
            echo "Postando commento sul commit ${{ github.sha }}..."
            
            # Usa le API di GitHub per commentare direttamente sul commit
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/commits/${{ github.sha }}/comments \
              -f body="$(cat ai_report.md)"
          else
            echo "Nessun report da pubblicare."
          fi
