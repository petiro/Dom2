name: OpenRouter AI Auditor

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Incolla qui l SHA del vecchio commit da revisionare'
        required: true

permissions:
  contents: write
  actions: read

jobs:
  ai_review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Requests
        run: pip install requests

      - name: Extract Diff (Smart Logic)
        id: extract
        run: |
          # LOGICA: Se Ã¨ manuale usa l'input, se Ã¨ push usa l'evento
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TARGET_SHA="${{ inputs.commit_sha }}"
            echo "MODALITA MANUALE: Revisione commit $TARGET_SHA"
            
            # Diff tra il commit scelto e il suo genitore (^)
            git diff $TARGET_SHA^ $TARGET_SHA > commit_diff.txt
            
            # Salviamo lo SHA per dopo
            echo "REVIEW_SHA=$TARGET_SHA" >> $GITHUB_ENV
            
          else
            echo "MODALITA PUSH: Revisione automatica"
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.event.after }}"
            
            if [ -z "$BEFORE" ] || [ "$BEFORE" == "0000000000000000000000000000000000000000" ]; then
               git diff 4b825dc642cb6eb9a060e54bf8d69288fbee4904 $AFTER > commit_diff.txt
            else
               git diff $BEFORE $AFTER > commit_diff.txt
            fi
            
            # Salviamo lo SHA corrente
            echo "REVIEW_SHA=$AFTER" >> $GITHUB_ENV
          fi

      - name: AI Analysis
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          python -c '
          import os
          import requests
          import json

          MODEL = "google/gemini-2.0-flash-exp:free"
          api_key = os.environ.get("OPENROUTER_API_KEY")

          try:
              with open("commit_diff.txt", "r", encoding="utf-8", errors="replace") as f:
                  diff_content = f.read()
          except:
              diff_content = ""

          if len(diff_content.strip()) < 5:
              print("Diff vuoto.")
              with open(os.environ["GITHUB_STEP_SUMMARY"], "a") as f:
                  f.write("### â„¹ï¸ Nessuna modifica rilevante.")
              exit(0)

          # Tronca a 20k per sicurezza
          diff_content = diff_content[:20000]

          prompt = f"""
          Sei un Code Reviewer. Analizza questo commit.
          Formatta la risposta in Markdown pulito.
          
          Se trovi ERRORI GRAVI (chiavi API, crash), inizia la riga con "ðŸš¨".
          Se Ã¨ tutto ok, inizia con "âœ…".
          
          DIFF:
          {diff_content}
          """

          try:
              response = requests.post(
                  url="https://openrouter.ai/api/v1/chat/completions",
                  headers={
                      "Authorization": f"Bearer {api_key}",
                      "HTTP-Referer": "https://github.com/v4-agent",
                      "Content-Type": "application/json"
                  },
                  json={
                      "model": MODEL,
                      "messages": [{"role": "user", "content": prompt}]
                  },
                  timeout=60
              )
              
              if response.status_code == 200:
                  report = response.json()["choices"][0]["message"]["content"]
                  
                  # 1. Salva per il commento
                  with open("ai_report.md", "w", encoding="utf-8") as f:
                      f.write(f"### ðŸ¤– AI Review ({MODEL})\n\n{report}")

                  # 2. Scrivi nel Job Summary
                  with open(os.environ["GITHUB_STEP_SUMMARY"], "a") as f:
                      f.write(f"### ðŸ¤– AI Review ({MODEL})\n\n{report}")
                  
                  # 3. Stampa Notice per i log
                  print(f"::notice title=AI Review Completata::Report generato! Controlla il Job Summary o i commenti del commit.")
                  
              else:
                  print(f"::error::Errore API OpenRouter: {response.text}")

          except Exception as e:
              print(f"::error::Errore script Python: {e}")
          '

      - name: Post Comment on Commit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f ai_report.md ]; then
            SHA_TO_COMMENT="${{ env.REVIEW_SHA }}"
            echo "Postando commento sul commit: $SHA_TO_COMMENT"
            
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/commits/$SHA_TO_COMMENT/comments \
              -F body=@ai_report.md
              
            echo "Commento postato con successo!"
          fi
