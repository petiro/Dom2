name: OpenRouter AI Auditor

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'SHA del vecchio commit da controllare'
        required: true

permissions:
  contents: write
  actions: read

jobs:
  ai_review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Requests
        run: pip install requests

      - name: Extract Diff
        id: extract
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TARGET_SHA="${{ inputs.commit_sha }}"
            echo "Manual Mode: $TARGET_SHA"
            git diff $TARGET_SHA^ $TARGET_SHA > commit_diff.txt
            echo "REVIEW_SHA=$TARGET_SHA" >> $GITHUB_ENV
          else
            echo "Push Mode"
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.event.after }}"
            if [ -z "$BEFORE" ] || [ "$BEFORE" == "0000000000000000000000000000000000000000" ]; then
               git diff 4b825dc642cb6eb9a060e54bf8d69288fbee4904 $AFTER > commit_diff.txt
            else
               git diff $BEFORE $AFTER > commit_diff.txt
            fi
            echo "REVIEW_SHA=$AFTER" >> $GITHUB_ENV
          fi

      - name: AI Analysis
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          python -c '
          import os
          import requests
          import json

          # Llama 3.3 70B: stable, free, good at code review
          MODEL = "meta-llama/llama-3.3-70b-instruct:free"
          
          api_key = os.environ.get("OPENROUTER_API_KEY")

          try:
              with open("commit_diff.txt", "r", encoding="utf-8", errors="replace") as f:
                  diff_content = f.read()
          except:
              diff_content = ""

          if len(diff_content.strip()) < 5:
              print("Diff vuoto.")
              with open("ai_report.md", "w") as f: f.write("Nessuna modifica.")
              exit(0)

          diff_content = diff_content[:30000]

          prompt = f"""
          Sei un Senior Code Reviewer.
          Analizza il seguente git diff.
          
          DIFF:
          {diff_content}
          
          OUTPUT: Markdown.
          Usa ðŸš¨ per errori critici.
          Usa âœ… per codice pulito.
          Sii BREVE.
          """

          try:
              response = requests.post(
                  url="https://openrouter.ai/api/v1/chat/completions",
                  headers={
                      "Authorization": f"Bearer {api_key}",
                      "HTTP-Referer": "https://github.com/v4-agent",
                      "Content-Type": "application/json"
                  },
                  json={
                      "model": MODEL,
                      "messages": [{"role": "user", "content": prompt}]
                  },
                  timeout=60
              )
              
              if response.status_code == 200:
                  report = response.json()["choices"][0]["message"]["content"]
                  
                  with open("ai_report.md", "w", encoding="utf-8") as f:
                      f.write(f"### ðŸ¦™ Llama Review ({MODEL})\n\n{report}")
                      
                  with open(os.environ["GITHUB_STEP_SUMMARY"], "a") as f:
                      f.write(f"### ðŸ¦™ Llama Review ({MODEL})\n\n{report}")
                  
              else:
                  err = f"Errore API {response.status_code}: {response.text}"
                  print(err)
                  with open("ai_report.md", "w") as f: f.write(err)

          except Exception as e:
              print(f"Errore Script: {e}")
          '

      - name: Post Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f ai_report.md ]; then
            SHA="${{ env.REVIEW_SHA }}"
            gh api --method POST \
              -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/commits/$SHA/comments \
              -F body=@ai_report.md || echo "Commento fallito (SHA non trovato?)"
          fi
